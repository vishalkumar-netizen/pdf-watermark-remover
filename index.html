<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PDF Logo / Watermark Remover</title>

  <!-- PDF.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      width: 95%;
      max-width: 500px;
      text-align: center;
    }

    h1 {
      font-size: 22px;
      margin-bottom: 10px;
    }

    input[type="file"] {
      margin: 15px 0;
    }

    button {
      padding: 10px 16px;
      border: none;
      background: #2563eb;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
    }

    button:disabled {
      background: gray;
      cursor: not-allowed;
    }

    #status {
      margin-top: 12px;
      font-size: 14px;
      color: #333;
    }

    canvas {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>PDF Logo / Watermark Remover</h1>

    <input type="file" id="pdfInput" accept="application/pdf" />
    <br />
    <button id="processBtn">Remove Watermark</button>
    <p id="status">Upload a PDF to begin.</p>
    <a id="downloadLink" style="display:none" download="cleaned.pdf">
      <button>Download Cleaned PDF</button>
    </a>

    <canvas id="canvas"></canvas>
  </div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

const input = document.getElementById("pdfInput");
const btn = document.getElementById("processBtn");
const status = document.getElementById("status");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const downloadLink = document.getElementById("downloadLink");

btn.onclick = async () => {
  if (!input.files[0]) {
    alert("Please upload a PDF first.");
    return;
  }

  status.innerText = "Loading PDF...";

  const file = input.files[0];
  const arrayBuffer = await file.arrayBuffer();

  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

  const cleanedPages = [];

  for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
    status.innerText = `Processing page ${pageNum}/${pdf.numPages}`;

    const page = await pdf.getPage(pageNum);
    const viewport = page.getViewport({ scale: 2 });

    canvas.width = viewport.width;
    canvas.height = viewport.height;

    await page.render({ canvasContext: ctx, viewport }).promise;

    // --- WATERMARK REMOVAL LOGIC ---
    // Strategy:
    // Light transparent logos are removed by whitening low-opacity pixels

    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;

    for (let i = 0; i < data.length; i += 4) {
      const r = data[i];
      const g = data[i + 1];
      const b = data[i + 2];

      const brightness = (r + g + b) / 3;

      // Detect faint watermark pixels
      if (brightness > 200) {
        data[i] = 255;
        data[i + 1] = 255;
        data[i + 2] = 255;
      }
    }

    ctx.putImageData(imageData, 0, 0);

    cleanedPages.push(canvas.toDataURL("image/jpeg", 1.0));
  }

  status.innerText = "Rebuilding cleaned PDF...";

  // Create PDF using jsPDF
  const script = document.createElement("script");
  script.src = "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";
  script.onload = () => buildPDF(cleanedPages);
  document.body.appendChild(script);
};

async function buildPDF(images) {
  const { jsPDF } = window.jspdf;

  const pdf = new jsPDF();

  images.forEach((img, index) => {
    if (index !== 0) pdf.addPage();
    pdf.addImage(img, "JPEG", 0, 0, 210, 297);
  });

  const blob = pdf.output("blob");
  const url = URL.createObjectURL(blob);

  downloadLink.href = url;
  downloadLink.style.display = "inline-block";

  status.innerText = "Done! Download your cleaned PDF.";
}
</script>
</body>
</html>
